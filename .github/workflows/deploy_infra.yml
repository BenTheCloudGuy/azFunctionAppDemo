name: Deploy Infrastructure with Terraform

on:
  push:
    branches:
      - main

jobs:
  terraform:
    name: Terraform Workflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.11.4

      - name: Terraform Init
        run: terraform init
        working-directory: infra/

      - name: Terraform Validate
        run: terraform validate
        working-directory: infra/

      - name: Terraform Format
        run: terraform fmt -check
        working-directory: infra/

      - name: Terraform Plan
        id: plan
        run: terraform plan -input=false -var-file="terraform.tfvars" -out=tfplan
        working-directory: infra/

      - name: Save Plan Output
        run: echo "TF_PLAN_PATH=tfplan" >> $GITHUB_ENV

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve $TF_PLAN_PATH
        working-directory: infra/

      - name: Collect Terraform Outputs and Save as Artifact
        id: save_outputs
        run: |
          terraform output -json > terraform-outputs.json
        working-directory: infra/

      - name: Upload Terraform Outputs as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: infra/terraform-outputs.json

      - name: Collect Terraform Outputs and Store as GitHub Repository Variables
        id: set_repo_variables
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FUNCTION_APP_NAME=$(terraform output -raw FunctionAppName)
          FUNC_RESOURCE_GROUP=$(terraform output -raw resource_group_name)
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          # Set repository variables using GitHub CLI
          gh variable set FUNCTION_APP_NAME --body "$FUNCTION_APP_NAME"
          gh variable set FUNC_RESOURCE_GROUP --body "$FUNC_RESOURCE_GROUP"
        working-directory: infra/
